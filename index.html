<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인터랙티브 거리 계산 지도</title>
    <style>
        :root { --bg-color: #1a1a1a; --sidebar-bg: #2c2c2c; --control-bg: #1e1e1e; --text-color: #e0e0e0; --text-secondary: #a0a0a0; --primary-color: #4a90e2; --primary-hover: #63a4ff; --border-color: #444; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; font-family: 'Malgun Gothic', '맑은 고딕', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; overflow: hidden; }
        #sidebar { width: 380px; height: 100%; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.3); z-index: 10; }
        #control-panel { padding: 20px; background-color: var(--control-bg); border-bottom: 1px solid var(--border-color); }
        .app-title { margin-top: 0; color: var(--primary-color); }
        .control-group { margin-bottom: 1.2rem; }
        label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 8px; color: var(--text-secondary); }
        input[type="range"] { width: 100%; }
        input[type="number"], input[type="text"], select { width: 100%; box-sizing: border-box; padding: 10px; background-color: var(--sidebar-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; }
        .input-with-button { display: flex; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s ease; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-primary:disabled { background-color: #555; cursor: not-allowed; }
        .btn-secondary { background-color: #555; color: white; }
        .btn-secondary:hover { background-color: #777; }
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .switch-label { vertical-align: super; margin-left: 10px; font-weight: bold; color: var(--text-color); }
        #result-panel { flex-grow: 1; overflow-y: auto; }
        .result-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: var(--control-bg); position: sticky; top: 0; z-index: 5; }
        #result-count { margin: 0; font-size: 16px; }
        #result-list { list-style: none; padding: 0; margin: 0; }
        #result-list li { padding: 15px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        #result-list li:hover { background-color: #3a3a3a; }
        #result-list li > div { display: flex; justify-content: space-between; align-items: center; }
        #result-list strong { font-size: 15px; }
        #result-list span { font-size: 13px; color: var(--text-secondary); }
        #map { width: 100%; height: 100%; }
        .infowindow { color: #333; padding: 5px; font-size: 13px; line-height: 1.6; }
        .infowindow strong { color: #000; font-size: 14px; }
        .infowindow a { color: var(--primary-color); text-decoration: none; font-weight: bold; }
        #loading-overlay, #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #modal-content { background-color: var(--sidebar-bg); padding: 30px; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; box-shadow: 0 5px 20px rgba(0,0,0,0.5); overflow-y: auto; position: relative; }
        #modal-close-btn { position: absolute; top: 15px; right: 20px; font-size: 2rem; color: var(--text-secondary); background: none; border: none; cursor: pointer; }
        #modal-body h1 { color: var(--primary-color); margin-top: 0; }
        .summary-table, .details-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .summary-table th, .details-table th { background-color: #3e3e3e; padding: 12px; text-align: left; }
        .summary-table td, .details-table td { padding: 12px; border-bottom: 1px solid var(--border-color); }
        .details-row > td { padding: 20px; background-color: var(--control-bg); }
        .details-container h3, .details-container h4 { color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-top: 20px; }
        .formula { font-family: monospace; background-color: var(--bg-color); padding: 15px; border-radius: 4px; word-break: break-all; }
        @media (max-width: 768px) { body { flex-direction: column; } #sidebar { width: 100%; height: 45%; max-height: 45vh; border-right: none; border-bottom: 1px solid var(--border-color); } #map { height: 55%; } }
    </style>
</head>
<body>
    <div id="loading-overlay" style="display:none;"><div class="spinner"></div><p></p></div>
    <div id="sidebar">
        <div id="control-panel">
            <h2 class="app-title">거리 계산 도우미</h2>
            <div class="control-group"><label class="switch"><input type="checkbox" id="sim-mode-checkbox"><span class="slider round"></span></label><label for="sim-mode-checkbox" class="switch-label">물량 배분 시뮬레이션</label></div>
            <div class="control-group"><label for="company-select">업체 선택</label><select id="company-select"><option value="all">전체</option></select></div>
            <div id="filter-controls">
                <div class="control-group"><label for="distance-slider">거리 필터 (km): <span id="distance-value">50</span> km</label><input type="range" id="distance-slider" min="0" max="100" value="50"></div>
                <div class="control-group"><label for="capacity-input">최소 보관허용량</label><input type="number" id="capacity-input" min="0" placeholder="0" value="0"></div>
                <button id="apply-filter-btn" class="btn-primary">조건으로 조회</button>
            </div>
            <div id="simulation-controls" style="display: none;">
                <div class="control-group"><label for="volume-input">총 반출토량</label><input type="number" id="volume-input" min="0" placeholder="예: 10000"></div>
                <div class="button-group"><button id="run-simulation-btn" class="btn-primary">시뮬레이션 실행</button><button id="run-all-compare-btn" class="btn-secondary">전체 업체 비교</button></div>
            </div>
            <hr style="border-color: var(--border-color); border-style: solid; margin: 20px 0;">
            <div class="control-group"><label for="start-address">출발지 주소 (임시 변경)</label><div class="input-with-button"><input type="text" id="start-address" placeholder="새 출발지 주소 입력"><button id="update-start-btn">변경</button></div></div>
        </div>
        <div id="result-panel">
            <div class="result-header"><h3 id="result-count">결과: 0개</h3><select id="sort-select"><option value="distance">거리순</option><option value="capacity_desc">용량 높은순</option></select></div>
            <ul id="result-list"></ul>
        </div>
    </div>
    <div id="map"></div>
    <div id="modal-overlay" style="display: none;"><div id="modal-content"><button id="modal-close-btn">&times;</button><div id="modal-body"></div></div></div>

    <script>
    // 전역 변수
    let map, startMarker, clusterer;
    let allDestinations = [], destinationMarkers = [];
    let currentPolyline = null;
    let companyList = new Set();
    
    // !!! 가장 중요한 부분 !!!
    // 2단계에서 복사한 앱스크립트 URL을 여기에 붙여넣으세요.
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbw9UgypqXTqeE6TKzWejF68yO33ejQlUGPIxs3OhRNcrdsQZ3smTXvnhlGoxiu7xeUy/exec';

    // 초기화
    document.addEventListener('DOMContentLoaded', () => {
        showLoading(true, "초기화 중입니다...");
        
        fetch(`${BACKEND_URL}?action=getWebData`)
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    const data = result.data;
                    const script = document.createElement('script');
                    script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${data.appKey}&libraries=services,clusterer,drawing&autoload=false`;
                    script.onload = () => {
                        kakao.maps.load(() => setupApp(data));
                    };
                    document.head.appendChild(script);
                } else {
                    showError({ message: result.message });
                }
            })
            .catch(err => showError({ message: '백엔드 서버에 연결할 수 없습니다.' }));

        bindEventListeners();
    });
    
    function setupApp(data) {
        allDestinations = data.destinations.map(dest => {
            const startLatLng = new kakao.maps.LatLng(data.startCoords.lat, data.startCoords.lng);
            const destLatLng = new kakao.maps.LatLng(dest.lat, dest.lng);
            const poly = new kakao.maps.Polyline({ path: [startLatLng, destLatLng] });
            dest.distance = Math.round(poly.getLength() / 10) / 100; // km
            companyList.add(dest.company);
            return dest;
        });

        const mapContainer = document.getElementById('map');
        const mapOption = { center: new kakao.maps.LatLng(data.startCoords.lat, data.startCoords.lng), level: 8 };
        map = new kakao.maps.Map(mapContainer, mapOption);

        const mapTypeControl = new kakao.maps.MapTypeControl();
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
        const zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
        
        const tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
        const darkMapTypeId = 'DARK_MAP';
        kakao.maps.Tileset.add(darkMapTypeId, tileUrl, '', false, 0, 19);
        const darkMapButton = new kakao.maps.CustomOverlay({
            content: '<span style="background-color: #333; color: white; padding: 5px; border-radius: 4px; cursor: pointer;">다크 모드</span>',
            position: new kakao.maps.LatLng(37.5, 127.0),
            zIndex: 1
        });
        
        // Note: Simple tile overlay. More complex dark mode would require more styling.
        
        clusterer = new kakao.maps.MarkerClusterer({ map: map, averageCenter: true, minLevel: 7 });

        startMarker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(data.startCoords.lat, data.startCoords.lng),
            image: new kakao.maps.MarkerImage('//t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', new kakao.maps.Size(64, 69), {offset: new kakao.maps.Point(27, 69)})
        });
        startMarker.setMap(map);

        document.getElementById('start-address').value = data.startAddress;
        
        populateCompanySelect();
        createDestinationMarkers();
        applyFilters();
        showLoading(false);
    }
    
    function bindEventListeners() {
        document.getElementById('sim-mode-checkbox').addEventListener('change', toggleMode);
        document.getElementById('apply-filter-btn').addEventListener('click', applyFilters);
        document.getElementById('run-simulation-btn').addEventListener('click', () => runSimulation(false));
        document.getElementById('run-all-compare-btn').addEventListener('click', () => runSimulation(true));
        
        const filterInputs = ['company-select', 'distance-slider', 'capacity-input', 'sort-select'];
        filterInputs.forEach(id => document.getElementById(id).addEventListener('input', applyFilters));
        
        document.getElementById('update-start-btn').addEventListener('click', updateStartAddress);
        document.getElementById('modal-close-btn').addEventListener('click', () => document.getElementById('modal-overlay').style.display = 'none');
    }

    function toggleMode() {
        const isSimMode = document.getElementById('sim-mode-checkbox').checked;
        document.getElementById('filter-controls').style.display = isSimMode ? 'none' : 'block';
        document.getElementById('simulation-controls').style.display = isSimMode ? 'block' : 'none';
        
        const companySelect = document.getElementById('company-select');
        const runSimBtn = document.getElementById('run-simulation-btn');
        if (isSimMode && companySelect.value === 'all') {
            runSimBtn.disabled = true;
        } else {
            runSimBtn.disabled = false;
        }
    }

    function populateCompanySelect() {
        const select = document.getElementById('company-select');
        companyList.forEach(company => {
            const option = document.createElement('option');
            option.value = company;
            option.textContent = company;
            select.appendChild(option);
        });
        select.addEventListener('change', () => {
            const isSimMode = document.getElementById('sim-mode-checkbox').checked;
            if (isSimMode && select.value === 'all') {
                document.getElementById('run-simulation-btn').disabled = true;
            } else {
                document.getElementById('run-simulation-btn').disabled = false;
            }
        });
    }

    function createDestinationMarkers() {
        const imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png';
        const imageSize = new kakao.maps.Size(36, 37);
        destinationMarkers = allDestinations.map((dest, i) => {
            const position = new kakao.maps.LatLng(dest.lat, dest.lng);
            const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, {
                spriteSize: new kakao.maps.Size(36, 691),
                spriteOrigin: new kakao.maps.Point(0, (i % 15) * 46 + 10),
                offset: new kakao.maps.Point(13, 37)
            });
            const marker = new kakao.maps.Marker({ position, image: markerImage });
            const infowindow = new kakao.maps.InfoWindow({
                content: `<div class="infowindow"><strong>${dest.name}</strong> (${dest.company})<br>용량: ${dest.capacity.toLocaleString()}<br>직선거리: ${dest.distance} km<br><a href="#" onclick="displayRoute(${dest.lat}, ${dest.lng}); return false;">실시간 경로 보기</a></div>`,
                removable: true
            });
            kakao.maps.event.addListener(marker, 'click', () => {
                destinationMarkers.forEach(item => item.infowindow.close());
                infowindow.open(map, marker);
            });
            return { marker, infowindow, data: dest };
        });
    }

    function applyFilters() {
        const company = document.getElementById('company-select').value;
        const distance = parseInt(document.getElementById('distance-slider').value);
        document.getElementById('distance-value').textContent = distance;
        const capacity = parseInt(document.getElementById('capacity-input').value) || 0;
        const sort = document.getElementById('sort-select').value;
        let filtered = allDestinations.filter(dest =>
            (company === 'all' || dest.company === company) &&
            dest.distance <= distance &&
            dest.capacity >= capacity
        );
        filtered.sort((a, b) => sort === 'distance' ? a.distance - b.distance : b.capacity - a.capacity);
        updateMapAndList(filtered);
    }

    function updateMapAndList(data) {
        clusterer.clear();
        const markersToShow = [];
        const markerMap = new Map(destinationMarkers.map(item => [item.data.address, item.marker]));
        data.forEach(d => {
            const marker = markerMap.get(d.address);
            if (marker) markersToShow.push(marker);
        });
        clusterer.addMarkers(markersToShow);
        updateResultList(data);
    }

    function updateResultList(data) {
        const listEl = document.getElementById('result-list');
        listEl.innerHTML = '';
        document.getElementById('result-count').textContent = `결과: ${data.length}개`;
        data.forEach(d => {
            const li = document.createElement('li');
            li.innerHTML = `<div><strong>${d.name}</strong><span>${d.company}</span></div><div><span>${d.distance} km</span><span>${d.capacity.toLocaleString()}</span></div>`;
            li.addEventListener('click', () => {
                const position = new kakao.maps.LatLng(d.lat, d.lng);
                map.setLevel(4, { anchor: position });
                map.panTo(position);
                const item = destinationMarkers.find(m => m.data.address === d.address);
                if (item) {
                    destinationMarkers.forEach(m => m.infowindow.close());
                    item.infowindow.open(map, item.marker);
                }
            });
            listEl.appendChild(li);
        });
    }

    function runSimulation(isAllCompare) {
        const totalVolume = parseInt(document.getElementById('volume-input').value);
        if (!totalVolume || totalVolume <= 0) {
            alert('총 반출토량을 입력해주세요.');
            return;
        }
        const companiesToRun = isAllCompare ? Array.from(companyList) : [document.getElementById('company-select').value];
        let results = [];
        companiesToRun.forEach(company => {
            let sites = allDestinations.filter(d => d.company === company).sort((a, b) => a.distance - b.distance);
            let remainingVolume = totalVolume;
            let weightedDistanceSum = 0;
            let allocatedVolumeTotal = 0;
            let allocationDetails = [];
            for (const site of sites) {
                if (remainingVolume <= 0) break;
                const volumeToAllocate = Math.min(remainingVolume, site.capacity);
                allocationDetails.push({ ...site, allocated: volumeToAllocate });
                weightedDistanceSum += site.distance * volumeToAllocate;
                remainingVolume -= volumeToAllocate;
                allocatedVolumeTotal += volumeToAllocate;
            }
            const weightedAvgDistance = allocatedVolumeTotal > 0 ? (weightedDistanceSum / allocatedVolumeTotal).toFixed(2) : 0;
            results.push({ company, weightedAvgDistance, allocatedVolumeTotal, totalVolume, allocationDetails });
        });
        displayResultsModal(results, isAllCompare);
    }

    function displayResultsModal(results, isAllCompare) {
        const modalBody = document.getElementById('modal-body');
        let html = `<h1>${isAllCompare ? '전체 업체 비교 결과' : `'${results[0].company}' 시뮬레이션 결과`}</h1>`;
        if (isAllCompare) {
            html += `<table class="summary-table"><thead><tr><th>업체명</th><th>가중 평균 거리</th><th>처리 가능 물량</th><th>상세보기</th></tr></thead><tbody>`;
            results.forEach((res, index) => {
                const isInsufficient = res.allocatedVolumeTotal < res.totalVolume;
                html += `<tr><td>${res.company}</td><td><strong>${res.weightedAvgDistance} km</strong></td><td ${isInsufficient ? 'style="color: #ff6b6b;"' : ''}>${res.allocatedVolumeTotal.toLocaleString()} / ${res.totalVolume.toLocaleString()}</td><td><button class="details-toggle" data-index="${index}">▼</button></td></tr><tr class="details-row" id="details-${index}" style="display:none;"><td colspan="4">${generateDetailsHtml(res)}</td></tr>`;
            });
            html += '</tbody></table>';
        } else {
            html += generateDetailsHtml(results[0]);
        }
        modalBody.innerHTML = html;
        document.getElementById('modal-overlay').style.display = 'flex';
        document.querySelectorAll('.details-toggle').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = e.target.dataset.index;
                const detailsRow = document.getElementById(`details-${index}`);
                const isVisible = detailsRow.style.display !== 'none';
                detailsRow.style.display = isVisible ? 'none' : 'table-row';
                e.target.textContent = isVisible ? '▼' : '▲';
            });
        });
    }

    function generateDetailsHtml(result) {
        let detailsHtml = `<div class="details-container"><div class="details-summary"><h3>${result.company}</h3><p>가중 평균 거리: <span>${result.weightedAvgDistance} km</span></p></div><h4>세부 배분 내역</h4><table class="details-table"><thead><tr><th>반입장명</th><th>거리</th><th>용량</th><th>배분량</th></tr></thead><tbody>`;
        result.allocationDetails.forEach(d => {
            detailsHtml += `<tr><td>${d.name}</td><td>${d.distance} km</td><td>${d.capacity.toLocaleString()}</td><td>${d.allocated.toLocaleString()}</td></tr>`;
        });
        detailsHtml += `</tbody></table><h4>계산식</h4><p class="formula">`;
        const formulaParts = result.allocationDetails.map(d => `(${d.distance}km × ${d.allocated.toLocaleString()})`);
        detailsHtml += `( ${formulaParts.join(' + ')} ) / ${result.allocatedVolumeTotal.toLocaleString()} = <strong>${result.weightedAvgDistance} km</strong></p></div>`;
        return detailsHtml;
    }

    function displayRoute(destLat, destLng) {
        showLoading(true, "경로를 계산 중입니다...");
        const startPos = startMarker.getPosition();
        const params = new URLSearchParams({ action: 'getRoute', originLat: startPos.getLat(), originLng: startPos.getLng(), destLat: destLat, destLng: destLng });
        fetch(`${BACKEND_URL}?${params.toString()}`)
            .then(res => res.json())
            .then(result => {
                if (result.success && result.data) {
                    const routeData = result.data;
                    if (currentPolyline) currentPolyline.setMap(null);
                    if (routeData.polyline) {
                        const linePath = [];
                        for(let i=0; i < routeData.polyline.length; i += 2) {
                            linePath.push(new kakao.maps.LatLng(routeData.polyline[i+1], routeData.polyline[i]));
                        }
                        currentPolyline = new kakao.maps.Polyline({ path: linePath, strokeWeight: 5, strokeColor: "#4a90e2", strokeOpacity: 0.8, strokeStyle: "solid" });
                        currentPolyline.setMap(map);
                        const bounds = new kakao.maps.LatLngBounds();
                        bounds.extend(startPos);
                        bounds.extend(new kakao.maps.LatLng(destLat, destLng));
                        map.setBounds(bounds);
                        alert(`실시간 경로 계산 완료!\n총 거리: ${(routeData.distance / 1000).toFixed(2)} km`);
                    }
                } else {
                    alert('경로 정보를 가져오는 데 실패했습니다.');
                }
                showLoading(false);
            })
            .catch(showError);
    }
    
    function updateStartAddress() {
        const newAddress = document.getElementById('start-address').value;
        if (!newAddress) return;
        showLoading(true, "새 출발지를 설정합니다...");
        const params = new URLSearchParams({ action: 'geocodeAddress', address: newAddress });
        fetch(`${BACKEND_URL}?${params.toString()}`)
            .then(res => res.json())
            .then(result => {
                if (result.success && result.data) {
                    const newCoords = result.data;
                    const newLatLng = new kakao.maps.LatLng(newCoords.lat, newCoords.lng);
                    map.setCenter(newLatLng);
                    startMarker.setPosition(newLatLng);
                    allDestinations.forEach(dest => {
                        const poly = new kakao.maps.Polyline({ path: [newLatLng, new kakao.maps.LatLng(dest.lat, dest.lng)] });
                        dest.distance = Math.round(poly.getLength() / 10) / 100;
                    });
                    if (currentPolyline) currentPolyline.setMap(null);
                    applyFilters();
                    alert('출발지가 성공적으로 변경되었습니다.');
                } else {
                    alert('주소를 좌표로 변환할 수 없습니다.');
                }
                showLoading(false);
            })
            .catch(showError);
    }

    function showLoading(isLoading, message = "데이터 로딩 중...") {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            overlay.querySelector('p').textContent = message;
            overlay.style.display = isLoading ? 'flex' : 'none';
        }
    }
    
    function showError(error) {
        alert("오류가 발생했습니다: " + error.message);
        showLoading(false);
    }
    </script>
</body>
</html>